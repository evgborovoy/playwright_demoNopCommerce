name: Playwright Python CI

on:
  push:
    branches: [ "main", "master", "dev" ]
  pull_request:
    branches: [ "main", "master", "dev" ]
  workflow_dispatch:

jobs:
  tests:
    name: tests (${{ matrix.browser }}${{ matrix.channel && format(' / {0}', matrix.channel) || '' }})
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          - browser: chromium
            channel: "chrome"
          - browser: firefox
            channel: ""
          - browser: webkit
            channel: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers and system deps
        run: |
          python -m playwright install --with-deps chromium firefox webkit

      - name: Run pytest (matrix shard)
        env:
          PYTEST_ADDOPTS: "-n auto -q"
        run: |
          mkdir -p allure-results
          EXTRA_CHANNEL_ARG=""
          if [ -n "${{ matrix.channel }}" ]; then
            EXTRA_CHANNEL_ARG="--channel=${{ matrix.channel }}"
          fi
          set -x
          pytest \
            --browser ${{ matrix.browser }} ${EXTRA_CHANNEL_ARG} \
            --alluredir=allure-results || true
          set +x

      - name: Upload Allure results (per shard)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}-${{ matrix.channel || 'stable' }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: allure-results
          if-no-files-found: warn
          retention-days: 10
          overwrite: true

  merge-and-publish:
    name: Merge & Publish Allure
    runs-on: ubuntu-latest
    needs: [ tests ]
    if: always()

    permissions:
      contents: write

    steps:
      - name: Download all shard artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: artifacts
          merge-multiple: false

      - name: Merge Allure results
        run: |
          mkdir -p merged-results
          if compgen -G "artifacts/*" > /dev/null; then
            find artifacts -type f -maxdepth 2 -print0 | xargs -0 -I {} cp "{}" merged-results/ || true
          fi
          echo "Merged results files: $(ls -1 merged-results 2>/dev/null | wc -l)"

      - name: Set up Node (for Allure CLI via npm)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Allure commandline
        run: |
          npm i -g allure-commandline
          allure --version

      - name: Generate Allure report
        shell: bash
        run: |
          if [ -d merged-results ] && [ "$(ls -A merged-results)" ]; then
            allure generate merged-results -o allure-report --clean
          else
            mkdir -p allure-report
            printf '%s\n' \
              '<!doctype html>' \
              '<html><head><meta charset="utf-8"><title>No Allure results</title></head>' \
              '<body style="font-family: sans-serif;">' \
              '  <h1>Allure</h1>' \
              '  <p>No allure results were produced in this run.</p>' \
              '</body></html>' > allure-report/index.html
          fi

      - name: Upload merged Allure report (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-merged-${{ github.run_id }}-${{ github.run_attempt }}
          path: allure-report
          retention-days: 10
          overwrite: true

      - name: Publish to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          force_orphan: true

      - name: Print report link
        if: always()
        run: |
          echo "‚úÖ Allure report published"
          echo "üåê https://${{ github.repository_owner }}.github.io/$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)/"
